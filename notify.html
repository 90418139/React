<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <title>Notify</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
</head>
<body>
<noscript>You need to enable JavaScript to run this app.</noscript>
<div class="container">
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <p class="card-text">
                        因為無後端，技術上的限制無法自動完成取得Line Notify代碼。
                        <br/>
                        所以要請你自己按送出。
                        <br/>
                        送出後會出現類似以下的代碼。
                        <br/>
                        <span class="text-danger">{"status":200,"message":"access_token is issued","access_token":"abcdefg1234567890"}</span>
                        <br/>
                        請複製下來後回到本頁貼到下面的格子。
                        <input class="form-control" name="token">
                    </p>
                    <span class="text-danger">注：本次動作只要做一次即可下次進入就不會再出現了</span>
                </div>
                <div class="card-footer">
                    <form id="idForm" method="post" enctype="application/x-www-form-urlencoded" action="https://notify-bot.line.me/oauth/token">
                        <input type="hidden" name="grant_type" value="authorization_code">
                        <input type="hidden" name="code" value="">
                        <input type="hidden" name="redirect_uri" value="https://90418139.github.io/React/notify">
                        <input type="hidden" name="client_id" value="MiC6LIxtzUOk6sipXu6XEN">
                        <input type="hidden" name="client_secret" value="93A5uyQ7XcpaMH0do3590GiWyF7OjCAAuqySB4QoaGn">
                        <button type="submit" class="btn btn-primary rounded-pill btn-block">取得Line Notify代碼</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const userId = urlParams.get('state');
    $('#idForm input[name=code]').val(code);
    $('input[name=token]').on('change', function () {
        let token = JSON.parse($('input[name=token]').val());
        if (token.status !== 200){
            alert('取得失敗請重試!!');
            location.replace(location.href.substring(0, location.href.indexOf('notify')));
        }
        _ = fireStoreAdd(userId, token.access_token);
    });
    async function fireStoreAdd(userId, token){
        firebase.initializeApp({
            apiKey: "AIzaSyAPCDWzc10yjGG-CmsCXGvZgmOmZ0AybYQ",
            authDomain: "remind-7d375.firebaseapp.com",
            databaseURL: "https://remind-7d375-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "remind-7d375",
            storageBucket: "remind-7d375.appspot.com",
            messagingSenderId: "870876543636",
            appId: "1:870876543636:web:c2005de339a9fba189d281",
            measurementId: "G-DN5M7P6BMZ"
        });
        let db = firebase.firestore();
        await db.collection("Remind2").add({
            userId: userId,
            notify: token,
        })
        .then((docRef) => {
            alert('取得成功!!');
            location.replace(location.href.substring(0, location.href.indexOf('notify')));
        })
        .catch((error) => {
            console.error("Error adding document: ", error);
        });
        return;
    }
</script>
</body>
</html>
