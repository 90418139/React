<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <title>Notify</title>
</head>
<body>
<noscript>You need to enable JavaScript to run this app.</noscript>
<div id="root"></div>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script
        src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
        crossorigin="anonymous"></script>
<script>
    let root = document.getElementById('root');
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const userId = urlParams.get('state');
    const token = getNotifyToken(code);
    _ = fireStoreAdd(userId, token);

    async function fireStoreAdd(userId, token){
        const firebase = require("firebase");
        // Required for side-effects
        require("firebase/firestore");
        // Initialize Cloud Firestore through Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyAPCDWzc10yjGG-CmsCXGvZgmOmZ0AybYQ",
            authDomain: "remind-7d375.firebaseapp.com",
            databaseURL: "https://remind-7d375-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "remind-7d375",
            storageBucket: "remind-7d375.appspot.com",
            messagingSenderId: "870876543636",
            appId: "1:870876543636:web:c2005de339a9fba189d281",
            measurementId: "G-DN5M7P6BMZ"
        });
        let db = firebase.firestore();
        await db.collection("Remind2").add({
            userId: userId,
            notify: token,
        })
        .then((docRef) => {
            console.log("Document written with ID: ", docRef.id);
        })
        .catch((error) => {
            console.error("Error adding document: ", error);
        });
        return;
    }
    async function getNotifyToken(code) {
        let fd = new FormData();
        fd.append( 'grant_type', 'authorization_code');
        fd.append( 'code', code);
        fd.append( 'redirect_uri', 'https://90418139.github.io/React/notify');
        fd.append( 'client_id', 'MiC6LIxtzUOk6sipXu6XEN');
        fd.append( 'client_secret', '93A5uyQ7XcpaMH0do3590GiWyF7OjCAAuqySB4QoaGn');
        let token = 'null';
        // const data = {
        //     grant_type: 'authorization_code',
        //     code: code,
        //     redirect_uri: 'https://90418139.github.io/React/notify',
        //     client_id: 'MiC6LIxtzUOk6sipXu6XEN',
        //     client_secret: '93A5uyQ7XcpaMH0do3590GiWyF7OjCAAuqySB4QoaGn'
        // };
        // await fetch("https://notify-bot.line.me/oauth/token",
        //     {
        //         method: "POST",
        //         mode: 'no-cors',
        //         headers: {
        //             "Content-Type": "application/x-www-form-urlencoded",
        //             'Access-Control-Allow-Origin': "*"
        //         },
        //         body: new URLSearchParams(data),
        //     }
        // )
        // .then(res => res.json())
        // .then(data => {
        //     token = data;
        //     console.log(data)
        // })
        // .catch(e => {
        //     console.error(e);
        // });

        $.ajax({
            type: 'POST',
            url: "https://notify-bot.line.me/oauth/token",
            processData: false,
            contentType: false,
            dataType: 'jsonp',
            data:  fd,
            success: function (r) {
                console.log(r);
                token = r;
                root.innerText = window.location.href + '\n' + code + '\n' + userId + '\n' + token;
            }
        });

        //root.innerText = window.location.href + '\n' + code + '\n' + userId + '\n' + token;
        return token;
    }
</script>
</body>
</html>
